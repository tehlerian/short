<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crypto Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
  <h2 id="chartTitle"></h2>
  <canvas id="chart" width="1200" height="600"></canvas>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const symbol = urlParams.get("symbol") || "BTCUSDT";
    document.getElementById("chartTitle").textContent = `Chart: ${symbol}`;

    async function getKlines(symbol, interval="15m", limit=200) {
      const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
      const data = await res.json();
      return data.map(d => ({
        x: new Date(d[0]),
        o: +d[1],
        h: +d[2],
        l: +d[3],
        c: +d[4]
      }));
    }

    function calcEMA(data, period) {
      const k = 2 / (period + 1);
      let emaArray = [];
      let prevEma;
      data.forEach((d, i) => {
        if (i === 0) {
          prevEma = d.c;
        } else {
          prevEma = d.c * k + prevEma * (1 - k);
        }
        emaArray.push({x: d.x, y: prevEma});
      });
      return emaArray;
    }

    async function renderChart() {
      const candles = await getKlines(symbol);
      const ema20 = calcEMA(candles, 20);
      const ema50 = calcEMA(candles, 50);

      const ctx = document.getElementById("chart").getContext("2d");
      new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [
            { label: "Candles", data: candles },
            { label: "EMA20", data: ema20, type: "line", borderColor: "blue", borderWidth: 1 },
            { label: "EMA50", data: ema50, type: "line", borderColor: "red", borderWidth: 1 }
          ]
        },
        options: {
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { type: 'time', time: { unit: 'minute' } }
          }
        }
      });
    }
    renderChart();
  </script>
</body>
</html>
