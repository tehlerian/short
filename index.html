<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crypto Chart (Line)</title>
  <style>
    body { font-family: Arial, sans-serif; }
    canvas { border: 1px solid #ccc; display: block; margin: 20px auto; }
    #info { text-align: center; margin-top: 10px; }
  </style>
</head>
<body>
  <h2 style="text-align:center">BTC/USDT Chart (15m)</h2>
  <canvas id="chart" width="1000" height="400"></canvas>
  <canvas id="rsiChart" width="1000" height="150"></canvas>
  <div id="info"></div>

  <script>
    async function getKlines(symbol="BTCUSDT", interval="15m", limit=200) {
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      const res = await fetch(url);
      return res.json();
    }

    function ema(values, period) {
      const k = 2 / (period + 1);
      let emaArray = [];
      let prevEma;
      values.forEach((val, i) => {
        if (i === 0) prevEma = val;
        else prevEma = val * k + prevEma * (1 - k);
        emaArray.push(prevEma);
      });
      return emaArray;
    }

    function rsi(values, period=14) {
      let rsiArray = [];
      let gains=0, losses=0;
      for (let i=1; i<=period; i++) {
        const diff = values[i]-values[i-1];
        if (diff>=0) gains+=diff; else losses-=diff;
      }
      let avgGain = gains/period, avgLoss = losses/period;
      let rs = avgGain/avgLoss;
      rsiArray.push(100 - (100/(1+rs)));
      for (let i=period+1; i<values.length; i++) {
        const diff = values[i]-values[i-1];
        if (diff>=0) {
          avgGain = (avgGain*(period-1)+diff)/period;
          avgLoss = (avgLoss*(period-1)+0)/period;
        } else {
          avgGain = (avgGain*(period-1)+0)/period;
          avgLoss = (avgLoss*(period-1)-diff)/period;
        }
        rs = avgLoss===0 ? 100 : avgGain/avgLoss;
        rsiArray.push(100 - (100/(1+rs)));
      }
      return rsiArray;
    }

    function drawLineChart(ctx, data, color) {
      ctx.strokeStyle = color;
      ctx.beginPath();
      data.forEach((y,i)=>{
        const x = i*(ctx.canvas.width/data.length);
        const yPos = ctx.canvas.height - (y-minVal)*scaleY;
        if (i===0) ctx.moveTo(x,yPos); else ctx.lineTo(x,yPos);
      });
      ctx.stroke();
    }

    let minVal, maxVal, scaleY;

    async function main() {
      const raw = await getKlines("BTCUSDT","15m",150);
      const closes = raw.map(d => +d[4]);
      const ema20 = ema(closes,20);
      const ema50 = ema(closes,50);
      const rsiVals = rsi(closes,14);

      // --- Chart price + EMA ---
      const canvas = document.getElementById("chart");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      minVal = Math.min(...closes);
      maxVal = Math.max(...closes);
      scaleY = canvas.height/(maxVal-minVal);

      drawLineChart(ctx, closes, "black");
      drawLineChart(ctx, ema20, "blue");
      drawLineChart(ctx, ema50, "orange");

      // --- RSI chart ---
      const rsiCanvas = document.getElementById("rsiChart");
      const rsiCtx = rsiCanvas.getContext("2d");
      rsiCtx.clearRect(0,0,rsiCanvas.width,rsiCanvas.height);
      const rsiStepX = rsiCanvas.width/rsiVals.length;
      rsiCtx.strokeStyle="purple";
      rsiCtx.beginPath();
      rsiVals.forEach((val,i)=>{
        const x = i*rsiStepX;
        const y = rsiCanvas.height - val*(rsiCanvas.height/100);
        if(i===0) rsiCtx.moveTo(x,y); else rsiCtx.lineTo(x,y);
      });
      rsiCtx.stroke();

      // RSI 70/30 lines
      rsiCtx.strokeStyle="gray";
      [30,70].forEach(level=>{
        const y = rsiCanvas.height - level*(rsiCanvas.height/100);
        rsiCtx.beginPath();
        rsiCtx.moveTo(0,y);
        rsiCtx.lineTo(rsiCanvas.width,y);
        rsiCtx.stroke();
      });

      document.getElementById("info").innerText = "Black=Price, Blue=EMA20, Orange=EMA50, Purple=RSI";
    }

    main();
  </script>
</body>
</html>
