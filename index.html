<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Binance Realtime Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #eee; }
    #symbolSelect { margin-bottom: 20px; padding: 5px; font-size: 16px; }
    canvas { background: #222; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>📊 Binance Realtime Scanner</h2>
  <select id="symbolSelect"></select>
  <canvas id="chart" width="900" height="450"></canvas>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;
    let ws;

    // --- Chart Init ---
    function initChart() {
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'candlestick', // ако искаш барове → "bar"
        data: { datasets: [{ label: 'Price', data: [] }] },
        options: {
          parsing: false,
          scales: {
            x: { type: 'time', time: { unit: 'minute' }, ticks: { color: '#ccc' } },
            y: { ticks: { color: '#ccc' } }
          }
        }
      });
    }

    // --- Fetch Top 200 Symbols ---
    async function loadSymbols() {
      const res = await fetch("https://api.binance.com/api/v3/ticker/24hr");
      const data = await res.json();
      // сортираме по обем и вземаме USDT двойки
      const sorted = data
        .filter(s => s.symbol.endsWith("USDT"))
        .sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
        .slice(0, 200);

      const select = document.getElementById('symbolSelect');
      select.innerHTML = "";
      sorted.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.symbol;
        opt.textContent = s.symbol;
        select.appendChild(opt);
      });

      select.value = "BTCUSDT"; // default
      loadChart(select.value);
      select.addEventListener("change", e => loadChart(e.target.value));
    }

    // --- Load Historical Data ---
    async function loadChart(symbol) {
      if (ws) ws.close();
      initChart();

      const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1m&limit=200`);
      const klines = await res.json();
      const data = klines.map(k => ({
        x: new Date(k[0]),
        o: parseFloat(k[1]),
        h: parseFloat(k[2]),
        l: parseFloat(k[3]),
        c: parseFloat(k[4])
      }));

      chart.data.datasets[0].data = data;
      chart.update();

      // WebSocket за нови свещи
      const url = `wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@kline_1m`;
      ws = new WebSocket(url);
      ws.onmessage = ev => {
        const msg = JSON.parse(ev.data);
        const k = msg.k;
        if (k.x) { // затворена свещ
          chart.data.datasets[0].data.push({
            x: new Date(k.t),
            o: parseFloat(k.o),
            h: parseFloat(k.h),
            l: parseFloat(k.l),
            c: parseFloat(k.c)
          });
          if (chart.data.datasets[0].data.length > 200) {
            chart.data.datasets[0].data.shift();
          }
          chart.update();
        }
      };
    }

    loadSymbols();
  </script>
</body>
</html>
