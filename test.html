// вместо wss://…@kline_4h ползваме 1h
const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_1h");
let hourly = [];      // току-що пристигнали 1h бара
let agg = [];         // готови 3h бара
const series = chart.addCandlestickSeries(); 

ws.onmessage = (evt) => {
  const { k } = JSON.parse(evt.data);
  const bar = {
    time: Math.floor(k.t/1000),
    open:+k.o, high:+k.h, low:+k.l, close:+k.c, closed:k.x
  };
  // Update или пълним буфера с hourly
  const lastH = hourly[hourly.length-1];
  if (lastH && lastH.time===bar.time) hourly[hourly.length-1]=bar;
  else hourly.push(bar);
  // Когато свещта се затвори и имаме по 3 елемента — агрегирай
  if (bar.closed && hourly.length % 3 === 0) {
    const group = hourly.slice(-3);
    const t0 = group[0].time;
    const o  = group[0].open;
    const h  = Math.max(...group.map(x=>x.high));
    const l  = Math.min(...group.map(x=>x.low));
    const c  = group[2].close;
    const mk = { time:t0, open:o, high:h, low:l, close:c };

    // апдейт или нов бар
    const lastA = agg[agg.length-1];
    if (lastA && lastA.time===mk.time) agg[agg.length-1]=mk;
    else {
      agg.push(mk);
      if (agg.length>200) agg.shift();
    }
    series.setData(agg);
  }
};
