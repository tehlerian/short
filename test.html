<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8"/>
  <title>Live BTC/USDT via WS</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body{margin:0;background:#0f141b;color:#cbd5e1;font-family:sans-serif}
    #chart{width:100%;height:560px}
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      layout:{background:{color:'#0f141b'},textColor:'#cbd5e1'},
      rightPriceScale:{visible:true},timeScale:{visible:true},
    });
    const series = chart.addCandlestickSeries();
    // държим буфер с последните 200 бара
    const buffer = [];
    function onMessage(evt){
      const msg = JSON.parse(evt.data);
      if (!msg.k) return;
      const k = msg.k;
      const bar = {
        time: Math.floor(k.t/1000),
        open: +k.o, high:+k.h, low:+k.l, close:+k.c
      };
      if (buffer.length && buffer[buffer.length-1].time===bar.time) {
        buffer[buffer.length-1] = bar;
      } else {
        buffer.push(bar);
        if (buffer.length>200) buffer.shift();
      }
      series.setData(buffer);
    }
    // Свързваме се към WS за 3h бара
    const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_3h");
    ws.onmessage = onMessage;
  </script>
</body>
</html>
