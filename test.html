<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>LW Charts Test</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; background: #0f141b; color: #cbd5e1; font-family: sans-serif; }
    #chart { width: 100%; height: 560px; min-height: 400px; display: block; }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    async function waitForContainerSize(el, timeoutMs = 3000) {
      const start = performance.now();
      while (el.clientWidth === 0 || el.clientHeight === 0) {
        await new Promise(r => setTimeout(r, 50));
        if (performance.now() - start > timeoutMs) break;
      }
      return { w: el.clientWidth || 800, h: el.clientHeight || 560 };
    }
    function observeResize(container, chart) {
      if (!('ResizeObserver' in window)) {
        window.addEventListener('resize', () => {
          chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
        });
        return;
      }
      const ro = new ResizeObserver(() => {
        chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
      });
      ro.observe(container);
    }
    (async function() {
      const el = document.getElementById('chart');
      const { w, h } = await waitForContainerSize(el);
      const chart = LightweightCharts.createChart(el, {
        width: w, height: h,
        layout: { background: { color: '#0f141b' }, textColor: '#cbd5e1' },
        rightPriceScale: { borderColor: '#1f2630' },
        timeScale: { borderColor: '#1f2630' },
        grid: { vertLines: { color: '#141a22' }, horzLines: { color: '#141a22' } },
      });
      observeResize(el, chart);
      const series = chart.addCandlestickSeries({
        upColor: '#16a34a', downColor: '#ef4444',
        borderUpColor: '#16a34a', borderDownColor: '#ef4444',
        wickUpColor: '#16a34a', wickDownColor: '#ef4444',
      });
      // Генерирай 150 тестови свещи
      const now = Math.floor(Date.now()/1000);
      const data = [];
      let px = 25000;
      for (let i = 150; i > 0; i--) {
        const t = now - i * 1800;
        const o = px + (Math.random()-0.5) * 50;
        const h = o + Math.random() * 80;
        const l = o - Math.random() * 80;
        const c = l + Math.random() * (h - l);
        data.push({ time: t, open: o, high: h, low: l, close: c });
        px = c;
      }
      series.setData(data);
    })();
  </script>
</body>
</html>